<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能英语单词默写 Pro</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Custom base styles and component designs */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom radio button styling to match the new UI */
        .custom-radio-group input[type="radio"] {
            display: none;
        }

        .custom-radio-group label {
            transition: all 0.2s ease-in-out;
        }

        .custom-radio-group input[type="radio"]:checked + label {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            box-shadow: 0 4px 14px 0 rgb(0 0 0 / 10%);
        }
        
        /* Custom checkbox styling */
        .custom-checkbox {
            accent-color: #4f46e5;
        }
        
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }
        
        /* Custom spinner for the loader */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        /* Custom styles for the practice selection tree */
        .subset-toggle.expanded {
            transform: rotate(90deg);
        }
        .words-list-container {
            display: none;
        }
        .words-list-container.show {
            display: block;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div class="container w-full max-w-2xl bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-slate-100 relative overflow-hidden">
        
        <!-- Loading Overlay -->
        <div id="loader" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex-col items-center justify-center gap-4" style="display: none;">
            <div class="spinner h-12 w-12 rounded-full border-4 border-slate-200 border-t-indigo-600"></div>
            <p id="loader-text" class="text-indigo-600 font-semibold text-lg">正在处理...</p>
        </div>

        <!-- Setup Section: Where users configure their practice -->
        <div id="setup-section">
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-900 tracking-tight">智能英语单词默写</h1>
                <p class="mt-2 text-slate-500">选择一种练习模式，开始你的学习之旅。</p>
            </header>
            
            <!-- Practice Mode Selection -->
            <div class="custom-radio-group grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6">
                <input type="radio" name="practice-mode" value="new-words" id="new-words-radio" checked>
                <label for="new-words-radio" class="flex flex-col items-center justify-center p-4 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-100 hover:border-slate-300">
                    <span class="font-bold text-lg">新单词练习</span>
                    <span class="text-sm text-slate-500">输入或上传新单词</span>
                </label>
                
                <input type="radio" name="practice-mode" value="wrong-words" id="wrong-words-radio" disabled>
                <label for="wrong-words-radio" class="flex flex-col items-center justify-center p-4 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-100 hover:border-slate-300 has-[:disabled]:cursor-not-allowed has-[:disabled]:bg-slate-50 has-[:disabled]:text-slate-400 has-[:disabled]:hover:bg-slate-50">
                    <span class="font-bold text-lg">错题练习</span>
                    <span class="text-sm"><span id="wrong-words-count">0</span> 个单词</span>
                </label>
                
                <input type="radio" name="practice-mode" value="word-library" id="word-library-radio">
                <label for="word-library-radio" class="flex flex-col items-center justify-center p-4 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-100 hover:border-slate-300">
                    <span class="font-bold text-lg">单词库练习</span>
                    <span class="text-sm text-slate-500">从云端题库选择</span>
                </label>
            </div>

            <!-- Area for New Words Input -->
            <div id="new-words-input-area" class="flex flex-col gap-4">
                <textarea id="word-input" class="w-full h-32 p-4 bg-slate-100 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:outline-none transition" placeholder="方法一：在此处输入单词，格式：apple - 苹果 / banana - 香蕉"></textarea>

                <div class="upload-section text-center p-4 border-2 border-dashed border-slate-300 rounded-lg bg-slate-50">
                    <p class="font-semibold text-slate-700 mb-3">方法二：上传单词文件 (图片, TXT, PDF, Word等)</p>
                    <div class="flex justify-center items-center gap-3">
                        <button id="select-file-button" class="px-4 py-2 bg-white border border-slate-300 text-slate-700 font-semibold rounded-md hover:bg-slate-100 transition shadow-sm">选择文件</button>
                        <button id="upload-confirm-button" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition shadow-sm disabled:bg-indigo-300 disabled:cursor-not-allowed" disabled>上传并识别</button>
                    </div>
                    <div id="upload-status" class="mt-3 text-sm text-slate-500 min-h-[20px]">未选择任何文件</div>
                </div>
                <input type="file" id="file-upload" accept="image/*,.txt,.csv,.doc,.docx,.xls,.xlsx,.pdf,.heic" class="hidden">
            </div>

            <!-- Area for Wrong Words Selection -->
            <div id="inline-wrong-words-selection" class="hidden flex-col gap-4 p-4 bg-slate-50 border border-slate-200 rounded-lg">
                <h3 class="text-lg font-bold text-center text-slate-800">选择错题练习会话</h3>
                <div id="inline-wrong-words-sessions-list" class="max-h-60 overflow-y-auto space-y-2 p-2 bg-white rounded-md border">
                    <!-- Session items will be injected here by JS -->
                </div>
                <div class="flex justify-end">
                    <button id="clear-wrong-words-button" class="px-4 py-2 bg-red-100 text-red-700 font-semibold rounded-md hover:bg-red-200 transition text-sm">清除所有错题记录</button>
                </div>
            </div>

            <!-- Area for Word Library Selection -->
            <div id="word-library-selection-area" class="hidden flex-col gap-4 p-4 bg-slate-50 border border-slate-200 rounded-lg">
                <h3 class="text-lg font-bold text-center text-slate-800">单词库练习</h3>
                <div id="selected-library-display" class="text-center font-semibold text-slate-600 bg-white p-3 rounded-md border border-slate-200">未选择单词</div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <button id="select-library-for-practice-button" class="w-full px-5 py-3 bg-white border border-slate-300 text-slate-700 font-semibold rounded-md hover:bg-slate-100 transition shadow-sm">选择练习内容</button>
                    <button id="open-manage-modal-button" class="w-full px-5 py-3 bg-white border border-slate-300 text-slate-700 font-semibold rounded-md hover:bg-slate-100 transition shadow-sm">管理单词库</button>
                </div>
            </div>

            <!-- Options & Start Button -->
            <div class="mt-6 space-y-3">
                <div class="flex items-center justify-center gap-3">
                    <input type="checkbox" id="auto-speak-checkbox" class="custom-checkbox h-5 w-5 rounded" checked>
                    <label for="auto-speak-checkbox" class="text-slate-600">练习时自动读出单词</label>
                </div>
                <div class="flex items-center justify-center gap-3">
                    <input type="checkbox" id="google-tts-checkbox" class="custom-checkbox h-5 w-5 rounded">
                    <label for="google-tts-checkbox" class="text-slate-600">使用更自然的 Google 翻译语音</label>
                </div>
            </div>

            <button id="start-button" class="w-full mt-8 py-4 text-xl font-bold text-white bg-indigo-600 rounded-lg shadow-lg hover:bg-indigo-700 transition-all disabled:bg-indigo-300 disabled:cursor-not-allowed disabled:shadow-none" disabled>开始练习</button>
        </div>

        <!-- Quiz Section: The main dictation interface -->
        <div id="quiz-section" style="display: none;">
            <div class="flex justify-between items-center mb-4">
                <div id="progress" class="font-bold text-slate-600 text-lg"></div>
                <button id="back-to-menu-button" class="px-3 py-1.5 bg-slate-200 text-slate-700 font-semibold rounded-md hover:bg-slate-300 transition text-sm">返回主页</button>
            </div>
            
            <!-- Chinese Prompt Card -->
            <div class="bg-indigo-600 text-white p-8 sm:p-12 rounded-xl shadow-2xl shadow-indigo-500/30 mb-6">
                <p class="text-center text-3xl sm:text-5xl font-bold tracking-wider" id="chinese-prompt"></p>
            </div>

            <input type="text" id="english-input" class="w-full text-center text-3xl font-mono py-4 bg-white border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:outline-none transition tracking-widest" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            
            <div id="feedback" class="text-center text-xl font-bold min-h-[30px] my-4 transition-all"></div>

            <!-- Example Sentence Display -->
            <div id="example-sentence-container" class="p-4 bg-slate-100 rounded-lg text-center space-y-1" style="display: none;">
                <p class="text-slate-500 text-sm font-semibold">例句</p>
                <p id="english-example-sentence" class="font-semibold text-indigo-700"></p>
                <p id="chinese-example-sentence" class="text-slate-600"></p>
            </div>

            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div id="check-button-container" class="quiz-actions">
                    <button id="check-button" class="w-full py-3 text-lg font-bold text-white bg-slate-800 rounded-lg shadow-md hover:bg-slate-900 transition">检查答案</button>
                </div>
                <div id="next-button-container" class="quiz-actions" style="display: none;">
                    <button id="next-button" class="w-full py-3 text-lg font-bold text-white bg-indigo-600 rounded-lg shadow-md hover:bg-indigo-700 transition">下一题</button>
                </div>
                <button id="speak-again-button" class="w-full py-3 text-lg font-bold text-slate-700 bg-slate-200 rounded-lg shadow-sm hover:bg-slate-300 transition">再读一次</button>
            </div>
        </div>

        <!-- Completion Section: Shows results after the quiz -->
        <div id="completion-section" class="text-center" style="display: none;">
            <h2 class="text-3xl font-extrabold text-green-600">练习结束！</h2>
            <div id="score-display" class="my-6 p-6 bg-slate-100 rounded-lg text-lg text-slate-700 leading-relaxed"></div>
            <div id="wrong-words-list" class="text-left"></div>
            <button id="restart-button" class="w-full max-w-sm mx-auto mt-8 py-3 text-lg font-bold text-white bg-indigo-600 rounded-lg shadow-lg hover:bg-indigo-700 transition">返回主页</button>
        </div>
    </div>

    <!-- General Message Dialog/Modal -->
    <div id="message-dialog" class="fixed inset-0 bg-black/50 z-[1001] flex-col items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-md text-center flex flex-col gap-6">
            <div id="message-dialog-text" class="text-slate-700 text-lg leading-relaxed"></div>
            <button id="message-dialog-close-button" class="self-center px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition shadow-sm">确定</button>
        </div>
    </div>

    <!-- Word Library Management Modal -->
    <div id="word-library-modal" class="fixed inset-0 bg-black/60 z-[1000] flex items-center justify-center p-4" style="display: none;">
        <div class="modal-content bg-slate-50 rounded-2xl shadow-2xl w-full max-w-3xl h-full max-h-[90vh] flex flex-col">
            <header class="flex-shrink-0 flex items-center justify-between p-6 border-b border-slate-200">
                <h2 id="modal-title" class="text-2xl font-bold text-slate-800">管理单词库</h2>
                <button id="modal-close-button" class="text-3xl text-slate-400 hover:text-slate-600 transition">&times;</button>
            </header>

            <main class="flex-grow p-6 overflow-y-auto space-y-6">
                <!-- View for Managing Libraries/Subsets/Words -->
                <div id="manage-view" class="space-y-6">
                    <section class="modal-section bg-white p-5 rounded-lg border border-slate-200 shadow-sm">
                        <h4 class="text-lg font-semibold text-slate-700 mb-3">我的单词库</h4>
                        <div class="flex gap-3">
                            <input type="text" id="new-library-name-input" class="flex-grow p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="新单词库名称">
                            <button id="create-library-button" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition shadow-sm">创建</button>
                        </div>
                        <div id="libraries-list" class="mt-4 max-h-40 overflow-y-auto border border-slate-200 rounded-md"></div>
                    </section>

                    <section id="subset-management-section" class="modal-section bg-white p-5 rounded-lg border border-slate-200 shadow-sm" style="display: none;">
                        <h4 class="text-lg font-semibold text-slate-700 mb-3">子集管理: <span id="current-library-name" class="text-indigo-600"></span></h4>
                        <div class="flex gap-3">
                            <input type="text" id="new-subset-name-input" class="flex-grow p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="新子集名称">
                            <button id="create-subset-button" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition shadow-sm">创建</button>
                        </div>
                        <div id="subsets-list" class="mt-4 max-h-40 overflow-y-auto border border-slate-200 rounded-md"></div>
                    </section>

                    <section id="words-management-section" class="modal-section bg-white p-5 rounded-lg border border-slate-200 shadow-sm" style="display: none;">
                        <h4 class="text-lg font-semibold text-slate-700 mb-3">编辑单词: <span id="current-subset-name" class="text-indigo-600"></span></h4>
                        <textarea id="subset-words-input" class="w-full h-40 p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="每行一个单词，格式：英文 - 中文"></textarea>
                        
                        <div class="mt-3 p-3 border border-dashed border-slate-300 rounded-lg bg-slate-50">
                            <p class="text-sm font-medium text-slate-600 mb-2">或从文件批量导入单词</p>
                            <div class="flex items-center gap-2">
                                <button id="select-subset-file-button" class="flex-shrink-0 px-3 py-1.5 bg-white border border-slate-300 text-slate-700 font-semibold rounded-md hover:bg-slate-100 transition text-sm">选择文件</button>
                                <span id="subset-upload-status" class="text-xs text-slate-500 truncate">未选择文件</span>
                            </div>
                            <button id="upload-subset-confirm-button" class="w-full mt-2 px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md hover:bg-indigo-600 transition text-sm disabled:bg-indigo-300" disabled>上传并导入</button>
                        </div>
                        <input type="file" id="subset-file-upload" accept="image/*,.txt,.csv,.doc,.docx,.xls,.xlsx,.pdf,.heic" class="hidden">
                        
                        <button id="save-subset-words-button" class="w-full mt-4 px-4 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700 transition shadow-sm">保存单词到子集</button>
                    </section>
                </div>

                <!-- View for Selecting Words for Practice -->
                <div id="select-view" style="display: none;">
                     <section class="modal-section bg-white p-5 rounded-lg border border-slate-200 shadow-sm">
                        <h4 class="text-lg font-semibold text-slate-700 mb-3">选择要练习的单词 (<span id="selected-word-count" class="text-indigo-600">0</span>)</h4>
                        <div id="library-selection-tree" class="max-h-[55vh] overflow-y-auto border border-slate-200 rounded-md p-3 space-y-4">
                            <!-- Selection tree will be injected here by JS -->
                        </div>
                    </section>
                    <button id="confirm-library-selection-button" class="w-full mt-4 px-5 py-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition shadow-sm disabled:bg-indigo-300" disabled>确认选择并返回</button>
                </div>
            </main>
        </div>
    </div>


    <script type="module">
        // Firebase imports (NO CHANGES TO LOGIC)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, setDoc, doc, onSnapshot, deleteDoc, writeBatch, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- All JavaScript logic from the original file remains here, unchanged. ---
        // --- The following is a direct copy of the original script block. ---

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous
        let isAuthReady = false;

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAOPiAwJCh61dH-rMBWfOM1nKZjiID6G-s",
            authDomain: "vocabulary-29bb0.firebaseapp.com",
            projectId: "vocabulary-29bb0",
            storageBucket: "vocabulary-29bb0.firebasestorage.app",
            messagingSenderId: "480495077641",
            appId: "1:480495077641:web:6cd7b1bea6a2a70f342bd8",
            measurementId: "G-VJ6E7C5S6V"
        };
        const appId = 'vocabulary-29bb0';
        const initialAuthToken = null;

        // Firestore Collection Paths
        const PUBLIC_LIBRARIES_COLLECTION = `artifacts/${appId}/public/data/wordLibraries`;
        const PUBLIC_SUBSETS_COLLECTION = `artifacts/${appId}/public/data/wordSubsets`;
        const PUBLIC_WORDS_COLLECTION = `artifacts/${appId}/public/data/libraryWords`;
        const USER_SESSIONS_COLLECTION_BASE = `artifacts/${appId}/users/`; 

        // Global variables for word library feature
        let allLibraries = [];
        let allSubsets = [];
        let selectedLibraryId = null;
        let selectedLibraryName = null;
        let selectedSubsetId = null;
        let selectedSubsetName = null;
        let allWordsInCurrentLibrary = []; 

        // Global variables for quiz and other features
        let words = []; 
        let wrongWordsCurrentSession = []; 
        let persistentWrongWords = []; 
        let currentWordIndex = 0;
        let score = 0;
        let selectedFile = null;
        let autoSpeakEnabled = true; 
        let googleTranslateTtsEnabled = false; 
        
        // --- Audio Caching and Player ---
        let audioCache = new Map();
        const audioPlayer = new Audio();
        let isAudioContextUnlocked = false;

        // --- Timer variables ---
        let wordStartTime = 0;
        let quizStartTime = null;

        // Session tracking variables
        let allPracticeSessions = [];
        let currentQuizDetails = {};

        // Get all necessary HTML elements
        const setupSection = document.getElementById('setup-section');
        const quizSection = document.getElementById('quiz-section');
        const completionSection = document.getElementById('completion-section');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');

        const newWordsInputArea = document.getElementById('new-words-input-area');
        const wordInput = document.getElementById('word-input');
        const selectFileButton = document.getElementById('select-file-button');
        const uploadConfirmButton = document.getElementById('upload-confirm-button');
        const uploadStatus = document.getElementById('upload-status');
        const fileUpload = document.getElementById('file-upload');
        const startButton = document.getElementById('start-button');
        const autoSpeakCheckbox = document.getElementById('auto-speak-checkbox'); 
        const googleTtsCheckbox = document.getElementById('google-tts-checkbox');
        const newWordsRadio = document.getElementById('new-words-radio'); 
        const wrongWordsRadio = document.getElementById('wrong-words-radio'); 
        const wrongWordsCountSpan = document.getElementById('wrong-words-count');
        const wordLibraryRadio = document.getElementById('word-library-radio');

        const progressText = document.getElementById('progress');
        const backToMenuButton = document.getElementById('back-to-menu-button');
        const chinesePrompt = document.getElementById('chinese-prompt');
        const englishInput = document.getElementById('english-input');
        const feedback = document.getElementById('feedback');
        const checkButton = document.getElementById('check-button');
        const nextButton = document.getElementById('next-button');
        const speakAgainButton = document.getElementById('speak-again-button'); 

        const scoreDisplay = document.getElementById('score-display');
        const wrongWordsList = document.getElementById('wrong-words-list');
        const restartButton = document.getElementById('restart-button');

        const inlineWrongWordsSelection = document.getElementById('inline-wrong-words-selection');
        const inlineWrongWordsSessionsList = document.getElementById('inline-wrong-words-sessions-list');

        const messageDialog = document.getElementById('message-dialog');
        const messageDialogText = document.getElementById('message-dialog-text');
        const messageDialogCloseButton = document.getElementById('message-dialog-close-button');

        const exampleSentenceContainer = document.getElementById('example-sentence-container');
        const englishExampleSentence = document.getElementById('english-example-sentence');
        const chineseExampleSentence = document.getElementById('chinese-example-sentence');

        const wordLibrarySelectionArea = document.getElementById('word-library-selection-area');
        const selectedLibraryDisplay = document.getElementById('selected-library-display');
        const selectLibraryForPracticeButton = document.getElementById('select-library-for-practice-button'); 
        const openManageModalButton = document.getElementById('open-manage-modal-button'); 

        const wordLibraryModal = document.getElementById('word-library-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalCloseButton = document.getElementById('modal-close-button');
        
        // Modal Views
        const manageView = document.getElementById('manage-view');
        const selectView = document.getElementById('select-view');
        const librarySelectionTree = document.getElementById('library-selection-tree');
        const selectedWordCountSpan = document.getElementById('selected-word-count');
        const confirmLibrarySelectionButton = document.getElementById('confirm-library-selection-button');

        // Manage View Elements
        const newLibraryNameInput = document.getElementById('new-library-name-input');
        const createLibraryButton = document.getElementById('create-library-button');
        const librariesList = document.getElementById('libraries-list');
        const subsetManagementSection = document.getElementById('subset-management-section');
        const currentLibraryNameSpan = document.getElementById('current-library-name');
        const newSubsetNameInput = document.getElementById('new-subset-name-input');
        const createSubsetButton = document.getElementById('create-subset-button');
        const subsetsList = document.getElementById('subsets-list');
        const wordsManagementSection = document.getElementById('words-management-section');
        const currentSubsetNameSpan = document.getElementById('current-subset-name');
        const subsetWordsInput = document.getElementById('subset-words-input');
        const saveSubsetWordsButton = document.getElementById('save-subset-words-button');
        const selectSubsetFileButton = document.getElementById('select-subset-file-button');
        const uploadSubsetConfirmButton = document.getElementById('upload-subset-confirm-button');
        const subsetUploadStatus = document.getElementById('subset-upload-status');
        const subsetFileUpload = document.getElementById('subset-file-upload');


        // --- Firebase Initialization ---
        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase authenticated. User ID:", userId);
                    } else {
                        console.log("Firebase not authenticated. Signing in anonymously...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            userId = auth.currentUser.uid;
                            console.log("Signed in anonymously. User ID:", userId);
                        } catch (error) {
                            console.error("Firebase anonymous sign-in failed:", error);
                            showMessage("无法登录到单词库服务。请检查网络或稍后重试。");
                        }
                    }
                    isAuthReady = true;
                    loadPracticeSessionsFromFirestore();
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Firebase 初始化失败。单词库功能将不可用。");
                isAuthReady = true; 
            }
        };
        initFirebase();


        // --- Gemini API Configuration ---
        const API_KEY = "AIzaSyB-TiVpLppqHtLUzsbip9YvYI82Tdqq-6E"; 
        const API_URL_TEXT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        // --- Custom Message Dialog Function ---
        const showMessage = (message) => {
            messageDialogText.innerHTML = message;
            messageDialog.style.display = 'flex';
        };

        messageDialogCloseButton.addEventListener('click', () => {
            messageDialog.style.display = 'none';
        });

        // --- Audio Context Unlock Function ---
        const unlockAudioContext = () => {
            if (isAudioContextUnlocked) return;
            const silentAudio = new Audio("data:audio/wav;base64,UklGRjIAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhIAAAAAA=");
            silentAudio.play().then(() => {
                isAudioContextUnlocked = true;
                console.log("Audio context unlocked successfully.");
            }).catch(error => {
                console.warn("Could not unlock audio context:", error);
            });
        };

        // --- Firestore-based Session Management Functions ---
        const loadPracticeSessionsFromFirestore = async () => {
            if (!isAuthReady || !userId) return;
            showLoader('正在加载错题记录...');
            try {
                const sessionsCollectionPath = `${USER_SESSIONS_COLLECTION_BASE}${userId}/practiceSessions`;
                const q = query(collection(db, sessionsCollectionPath), orderBy("endTime", "desc"));
                const querySnapshot = await getDocs(q);

                allPracticeSessions = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const overallUniqueWrongWordsMap = new Map();
                allPracticeSessions.forEach(session => {
                    if(session.sessionWords && Array.isArray(session.sessionWords)) {
                        session.sessionWords.forEach(word => {
                            if (!word.wasCorrect) {
                                if (!overallUniqueWrongWordsMap.has(word.english) || overallUniqueWrongWordsMap.get(word.english).timestamp < session.endTime.toMillis()) {
                                    overallUniqueWrongWordsMap.set(word.english, {
                                        english: word.english,
                                        chinese: word.chinese,
                                        timestamp: session.endTime.toMillis()
                                    });
                                }
                            }
                        });
                    }
                });
                persistentWrongWords = Array.from(overallUniqueWrongWordsMap.values());
                wrongWordsCountSpan.textContent = persistentWrongWords.length;
                wrongWordsRadio.disabled = persistentWrongWords.length === 0;

            } catch (error) {
                console.error("Error loading practice sessions from Firestore:", error);
                showMessage("加载错题记录失败。请检查您的网络连接。");
            } finally {
                hideLoader();
                updateStartButtonState();
            }
        };

        const savePracticeSessionToFirestore = async () => {
            if (!isAuthReady || !userId || words.length === 0) return;

            const quizEndTime = new Date();
            const totalDurationSeconds = (quizEndTime - quizStartTime) / 1000;
            const accuracy = score / words.length;

            const sessionData = {
                ...currentQuizDetails,
                userId: userId,
                startTime: quizStartTime,
                endTime: quizEndTime,
                totalDurationSeconds: totalDurationSeconds,
                score: score,
                totalWords: words.length,
                accuracy: accuracy,
                sessionWords: words.map(w => ({
                    english: w.english,
                    chinese: w.chinese,
                    wasCorrect: w.wasCorrect || false,
                    timeTakenSeconds: w.timeTakenSeconds || 0
                }))
            };

            try {
                const sessionsCollectionPath = `${USER_SESSIONS_COLLECTION_BASE}${userId}/practiceSessions`;
                await addDoc(collection(db, sessionsCollectionPath), sessionData);
                console.log("Practice session saved to Firestore.");
            } catch (error) {
                console.error("Error saving practice session to Firestore:", error);
                showMessage("无法保存本次练习记录，请检查网络。");
            } finally {
                await loadPracticeSessionsFromFirestore();
            }
        };


        // --- Utility Functions ---
        const showLoader = (text) => { loaderText.textContent = text; loader.style.display = 'flex'; };
        const hideLoader = () => { loader.style.display = 'none'; };
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        const parseWordInput = (text) => {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            return lines.map(line => {
                const parts = line.split(/[-=＝－]/).map(part => part.trim()); // Split by various delimiters
                if (parts.length >= 2 && parts[0] && parts[1]) {
                    return { english: parts[0], chinese: parts[1] };
                } else if (parts.length === 1 && parts[0]) {
                    return { english: parts[0], chinese: null };
                }
                return null;
            }).filter(Boolean);
        };

        // --- Audio Pre-fetch Function ---
        const prefetchAudio = async (word) => {
            if (audioCache.has(word) || !googleTranslateTtsEnabled) return;
            try {
                const targetUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(word)}&tl=en&client=tw-ob`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;
                
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('获取音频文件失败: ' + response.statusText);
                const audioBlob = await response.blob();
                audioCache.set(word, audioBlob);
                console.log(`音频 "${word}" 已被预加载和缓存。`);
            } catch (error) {
                console.error(`无法预加载音频 "${word}":`, error);
            }
        };

        const speak = async (text) => {
            if (!audioPlayer.paused) audioPlayer.pause();

            if (googleTranslateTtsEnabled) {
                let audioBlob = audioCache.get(text);
                if (!audioBlob) {
                    try {
                        const targetUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=en&client=tw-ob`;
                        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;
                        const response = await fetch(proxyUrl);
                        if (!response.ok) throw new Error('获取音频文件失败');
                        audioBlob = await response.blob();
                        audioCache.set(text, audioBlob);
                    } catch (error) {
                        console.error("播放 Google TTS 音频时出错:", error);
                        showMessage("无法加载单词发音，请检查网络连接。");
                        return;
                    }
                }
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayer.src = audioUrl;
                audioPlayer.play().catch(e => console.error("音频播放失败:", e));
            } else if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            } else {
                showMessage('您的浏览器不支持语音功能。');
            }
        };

        // --- Gemini API Calls for Translation and Verification ---
        const extractTextFromFile = async (base64Data, mimeType) => {
            const payload = {
                contents: [{
                    parts: [
                        { text: "Extract all text from the provided file. If the file contains English words, with or without Chinese translations, list them in a clean format (e.g., one word or 'English = Chinese' pair per line). If no clear word pairs are found, return the raw text content." },
                        { inlineData: { mimeType: mimeType, data: base64Data } }
                    ]
                }]
            };
            const response = await fetch(API_URL_TEXT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Gemini API Error: ${response.statusText}`);
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error("Could not extract text from the file.");
            return text;
        };

        const callGeminiForTranslation = async (englishWordsOnly) => {
            const prompt = `Translate the following English words to Chinese. Provide the response as a valid JSON array of objects, where each object has 'english' and 'chinese' keys. Words: ${JSON.stringify(englishWordsOnly)}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "english": { "type": "STRING" }, "chinese": { "type": "STRING" } }, required: ["english", "chinese"] } } }
            };
            const response = await fetch(API_URL_TEXT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) throw new Error("Could not get translations.");
            return JSON.parse(jsonText);
        };

        const callGeminiForVerification = async (wordsWithProvidedChinese) => {
            const formattedWords = wordsWithProvidedChinese.map(w => ({ english: w.english, provided_chinese: w.chinese }));
            const prompt = `For each English word and its provided Chinese translation, indicate if the translation is accurate. If not, provide the correct translation. Format the response as a valid JSON array of objects, where each object has 'english', 'provided_chinese', 'is_accurate' (boolean), and 'correct_chinese' (string, only if not accurate). Words: ${JSON.stringify(formattedWords)}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { 
                    responseMimeType: "application/json", 
                    responseSchema: { 
                        type: "ARRAY", 
                        items: { 
                            type: "OBJECT", 
                            properties: { 
                                "english": { "type": "STRING" }, 
                                "provided_chinese": { "type": "STRING" },
                                "is_accurate": { "type": "BOOLEAN" },
                                "correct_chinese": { "type": "STRING" } 
                            }, 
                            required: ["english", "provided_chinese", "is_accurate"] 
                        } 
                    } 
                }
            };
            const response = await fetch(API_URL_TEXT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) throw new Error("Could not get verification results.");
            return JSON.parse(jsonText);
        };

        const callGeminiForExampleSentenceAndTranslation = async (englishWord) => {
            const prompt = `Please generate a simple and common English example sentence for the word '${englishWord}'. Immediately after the English sentence, provide its Chinese translation. Format the response as a JSON object with 'englishSentence' and 'chineseSentence' keys.`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "englishSentence": { "type": "STRING" },
                            "chineseSentence": { "type": "STRING" }
                        },
                        required: ["englishSentence", "chineseSentence"]
                    }
                }
            };
            const response = await fetch(API_URL_TEXT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) throw new Error("Could not generate example sentence and translation.");
            return JSON.parse(jsonText);
        };


        const processWordsForQuiz = async (inputWords) => {
            const wordsWithoutChinese = inputWords.filter(w => !w.chinese);
            const wordsWithChinese = inputWords.filter(w => w.chinese);

            let translatedWords = [];
            let wordsToReturn = [...wordsWithChinese]; 

            if (wordsWithoutChinese.length > 0) {
                showLoader('正在翻译新单词...');
                const englishOnlyList = wordsWithoutChinese.map(w => w.english);
                try {
                    translatedWords = await callGeminiForTranslation(englishOnlyList);
                    wordsToReturn = [...wordsToReturn, ...translatedWords];
                } catch (error) {
                    console.error("翻译新单词时出错:", error);
                    showMessage("翻译新单词时发生错误，请检查网络或重试。");
                    return [];
                }
            }

            if (wordsWithChinese.length > 0) {
                showLoader('正在验证已有翻译...');
                try {
                    const verifiedResults = await callGeminiForVerification(wordsWithChinese);
                    
                    verifiedResults.forEach(verifiedWord => {
                        if (!verifiedWord.is_accurate) {
                            const message = `翻译不准确：<br>英文: <strong>${verifiedWord.english}</strong><br>您提供的中文: <strong>${verifiedWord.provided_chinese}</strong><br>正确翻译应为: <strong>${verifiedWord.correct_chinese}</strong>。已自动更新。`;
                            showMessage(message);
                            const wordInList = wordsToReturn.find(w => w.english === verifiedWord.english);
                            if (wordInList) {
                                wordInList.chinese = verifiedWord.correct_chinese;
                            }
                        }
                    });
                } catch (error) {
                    console.error("验证已有翻译时出错:", error);
                    showMessage("验证已有翻译时发生错误，将使用您提供的翻译。");
                }
            }

            const finalWordsMap = new Map();
            wordsToReturn.forEach(word => {
                finalWordsMap.set(word.english.toLowerCase(), word);
            });

            return Array.from(finalWordsMap.values());
        };


        // --- Main Application Flow ---
        const startQuiz = () => {
            if (words.length === 0) {
                showMessage('没有可供练习的单词。');
                return;
            }

            quizStartTime = new Date();
            currentWordIndex = 0;
            score = 0;
            
            currentQuizDetails = {};
            if (newWordsRadio.checked) {
                currentQuizDetails.practiceMode = '新单词练习';
            } else if (wrongWordsRadio.checked) {
                currentQuizDetails.practiceMode = '错题练习';
            } else if (wordLibraryRadio.checked) {
                currentQuizDetails.practiceMode = '单词库练习';
                // We don't log library info anymore as it can be mixed
            }
            
            words.forEach(word => {
                word.wasCorrect = false;
                word.timeTakenSeconds = 0;
            });
            
            shuffleArray(words);
            
            setupSection.style.display = 'none';
            completionSection.style.display = 'none';
            quizSection.style.display = 'block';

            showNextWord();
        };

        // --- Quiz Logic ---
        const checkAnswer = async () => {
            const timeTakenSeconds = (performance.now() - wordStartTime) / 1000;
            words[currentWordIndex].timeTakenSeconds = timeTakenSeconds;

            const userAnswer = englishInput.value.trim().toLowerCase();
            const correctAnswer = words[currentWordIndex].english.toLowerCase();
            
            if (userAnswer === '') {
                feedback.textContent = '请输入答案！';
                feedback.className = 'text-yellow-600';
                return;
            }

            if (userAnswer === correctAnswer) {
                score++;
                words[currentWordIndex].wasCorrect = true;
                feedback.innerHTML = `✔ 正确! <span class="text-sm text-slate-500">(${timeTakenSeconds.toFixed(2)}s)</span>`;
                feedback.className = 'text-green-600';
            } else {
                words[currentWordIndex].wasCorrect = false;
                const currentWord = words[currentWordIndex];
                feedback.innerHTML = `❌ 错误！正确答案是: <strong class="text-slate-800">${currentWord.english}</strong> <span class="text-sm text-slate-500">(${timeTakenSeconds.toFixed(2)}s)</span>`;
                feedback.className = 'text-red-600';
            }

            englishInput.disabled = true;
            document.getElementById('check-button-container').style.display = 'none';
            document.getElementById('next-button-container').style.display = 'block';
            nextButton.focus();

            showLoader('正在生成例句...');
            try {
                const exampleData = await callGeminiForExampleSentenceAndTranslation(words[currentWordIndex].english);
                englishExampleSentence.textContent = exampleData.englishSentence;
                chineseExampleSentence.textContent = exampleData.chineseSentence;
                exampleSentenceContainer.style.display = 'block';
            } catch (error) {
                console.error("生成例句时出错:", error);
                exampleSentenceContainer.style.display = 'none';
            } finally {
                hideLoader();
            }
        };

        const showNextWord = () => {
            exampleSentenceContainer.style.display = 'none';
            englishExampleSentence.textContent = '';
            chineseExampleSentence.textContent = '';

            if (currentWordIndex < words.length) {
                const word = words[currentWordIndex];
                progressText.textContent = `第 ${currentWordIndex + 1} / ${words.length} 题`;
                chinesePrompt.textContent = word.chinese;
                englishInput.placeholder = '_ '.repeat(word.english.length).trim();
                englishInput.value = '';
                englishInput.disabled = false;
                feedback.textContent = '';
                feedback.className = '';
                document.getElementById('check-button-container').style.display = 'block';
                document.getElementById('next-button-container').style.display = 'none';
                englishInput.focus();
                
                wordStartTime = performance.now();
                
                if (autoSpeakEnabled) {
                    speak(word.english);
                }
                
                if (currentWordIndex + 1 < words.length) {
                    prefetchAudio(words[currentWordIndex + 1].english);
                }

            } else {
                showCompletionScreen();
            }
        };

        const showCompletionScreen = async () => {
            await savePracticeSessionToFirestore();

            quizSection.style.display = 'none';
            completionSection.style.display = 'block';
            
            const totalDurationSeconds = words.length > 0 ? (new Date() - quizStartTime) / 1000 : 0;
            const averageTimePerWord = words.length > 0 ? words.reduce((acc, word) => acc + (word.timeTakenSeconds || 0), 0) / words.length : 0;
            const percentage = words.length > 0 ? Math.round((score / words.length) * 100) : 0;
            
            scoreDisplay.innerHTML = `你答对了 <strong>${score}</strong> 道题，共 <strong>${words.length}</strong> 道。<br>正确率: <strong>${percentage}%</strong><br>总用时: <strong>${totalDurationSeconds.toFixed(2)}</strong> 秒<br>平均用时: <strong>${averageTimePerWord.toFixed(2)}</strong> 秒/词`;
            
            wrongWordsList.innerHTML = '';
            const sessionWrongWords = words.filter(word => !word.wasCorrect);

            if (sessionWrongWords.length > 0) {
                let html = '<h3 class="text-xl font-bold text-red-600 text-center my-4">本次错题：</h3><ul class="space-y-2">';
                sessionWrongWords.forEach(word => {
                    html += `<li class="bg-red-50 border border-red-200 p-3 rounded-md flex justify-between items-center">
                                <div><strong>${word.english}</strong>: ${word.chinese}</div>
                                <div class="text-sm text-red-500">${(word.timeTakenSeconds || 0).toFixed(2)}s</div>
                             </li>`;
                });
                html += '</ul>';
                wrongWordsList.innerHTML = html;
            } else {
                if (words.length > 0 && score === words.length) {
                     wrongWordsList.innerHTML = '<p class="text-green-600 font-bold text-center mt-4">太棒了，全部正确！</p>';
                } else {
                     wrongWordsList.innerHTML = '<p class="text-slate-500 font-bold text-center mt-4">本次练习没有错题。</p>';
                }
            }
        };


        checkButton.addEventListener('click', checkAnswer);
        englishInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter' && !englishInput.disabled) checkAnswer();
        });
        nextButton.addEventListener('click', () => {
            currentWordIndex++;
            showNextWord();
        });
        speakAgainButton.addEventListener('click', () => {
            if(currentWordIndex < words.length) {
                speak(words[currentWordIndex].english);
            }
        });
        backToMenuButton.addEventListener('click', () => {
            showCompletionScreen();
        });

        restartButton.addEventListener('click', () => {
            completionSection.style.display = 'none';
            setupSection.style.display = 'block';
            
            words = [];
            wordInput.value = '';
            uploadStatus.textContent = '未选择任何文件';
            fileUpload.value = '';
            selectedFile = null;
            startButton.disabled = true;
            uploadConfirmButton.disabled = true;
            autoSpeakCheckbox.checked = true;
            autoSpeakEnabled = true;
            googleTtsCheckbox.checked = false;
            googleTranslateTtsEnabled = false;
            newWordsRadio.checked = true;
            
            audioCache.clear();

            loadPracticeSessionsFromFirestore();
            hideInlineWrongWordsSelection();
            updatePracticeModeDisplay();
            updateStartButtonState();
        });

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        };

        const updateStartButtonState = () => {
            let canStart = false;
            if (newWordsRadio.checked) {
                canStart = wordInput.value.trim() !== '' || words.length > 0;
            } else if (wrongWordsRadio.checked) {
                const checkedSessions = inlineWrongWordsSessionsList.querySelectorAll('input[type="checkbox"]:checked');
                canStart = checkedSessions.length > 0;
            } else if (wordLibraryRadio.checked) {
                canStart = words.length > 0;
            }
            startButton.disabled = !canStart;
        };

        const updatePracticeModeDisplay = () => {
            if (newWordsRadio.checked) {
                newWordsInputArea.style.display = 'flex';
                hideInlineWrongWordsSelection();
                wordLibrarySelectionArea.style.display = 'none';
            } else if (wrongWordsRadio.checked) {
                newWordsInputArea.style.display = 'none';
                if (persistentWrongWords.length > 0) {
                    showInlineWrongWordsSelection();
                } else {
                    hideInlineWrongWordsSelection();
                }
                wordLibrarySelectionArea.style.display = 'none';
            } else if (wordLibraryRadio.checked) {
                newWordsInputArea.style.display = 'none';
                hideInlineWrongWordsSelection();
                wordLibrarySelectionArea.style.display = 'flex';
                updateSelectedLibraryDisplay();
            }
            updateStartButtonState();
        };


        // --- Inline Wrong Words Selection Logic ---
        const showInlineWrongWordsSelection = () => {
            inlineWrongWordsSessionsList.innerHTML = '';
            if (allPracticeSessions && allPracticeSessions.length > 0) {
                allPracticeSessions.forEach(session => {
                    const wrongWordsInSession = session.sessionWords?.filter(w => !w.wasCorrect) || [];
                    if (wrongWordsInSession.length === 0) return;

                    const sessionItem = document.createElement('div');
                    sessionItem.className = 'session-item bg-white p-3 rounded-md border border-slate-200';
                    sessionItem.dataset.sessionId = session.id;

                    const sessionHeader = document.createElement('div');
                    sessionHeader.className = 'session-header flex items-center cursor-pointer';
                    
                    const sessionDate = session.endTime.toDate ? session.endTime.toDate().toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '未知日期';
                    const accuracyText = session.accuracy !== undefined ? `${(session.accuracy * 100).toFixed(0)}%` : 'N/A';
                    const modeText = session.practiceMode || '未知模式';

                    sessionHeader.innerHTML = `
                        <input type="checkbox" value="${session.id}" class="h-4 w-4 mr-3 custom-checkbox">
                        <div class="flex-grow">
                            <div class="font-semibold text-slate-700">${sessionDate}</div>
                            <div class="text-sm text-slate-500">${wrongWordsInSession.length} 个错词, 正确率 ${accuracyText} - ${modeText}</div>
                        </div>
                        <span class="toggle-icon text-slate-400 transition-transform">▶</span>
                    `;
                    sessionItem.appendChild(sessionHeader);

                    const wordsList = document.createElement('ul');
                    wordsList.className = 'session-words-list mt-2 pt-2 border-t border-slate-100 pl-4 space-y-1 hidden';
                    (session.sessionWords || []).forEach(word => {
                        if(!word.wasCorrect) {
                            const listItem = document.createElement('li');
                            listItem.className = 'text-sm text-slate-600';
                            listItem.innerHTML = `❌ ${word.english}: ${word.chinese}`;
                            wordsList.appendChild(listItem);
                        }
                    });
                    sessionItem.appendChild(wordsList);

                    inlineWrongWordsSessionsList.appendChild(sessionItem);

                    sessionHeader.addEventListener('click', (e) => {
                        if (e.target.type === 'checkbox') return;
                        e.stopPropagation();
                        wordsList.classList.toggle('hidden');
                        sessionHeader.querySelector('.toggle-icon').classList.toggle('rotate-90');
                    });
                });
            } else {
                inlineWrongWordsSessionsList.innerHTML = '<p class="text-center text-slate-500 p-4">暂无错题记录。</p>';
            }
            inlineWrongWordsSelection.style.display = 'flex';
            updateStartButtonState();
        };

        const hideInlineWrongWordsSelection = () => {
            inlineWrongWordsSelection.style.display = 'none';
            updateStartButtonState();
        };

        inlineWrongWordsSessionsList.addEventListener('change', (event) => {
            if (event.target.type === 'checkbox') {
                updateStartButtonState();
            }
        });


        document.getElementById('clear-wrong-words-button').addEventListener('click', () => {
             showMessage(`请输入确认码以清除所有错题记录。<br>此操作不可撤销！<br><br><input type="text" id="confirm-code-input" class="w-full p-2 border border-slate-300 rounded-md" placeholder="输入确认码"><br><div class="flex gap-2 mt-4 justify-center"><button id="confirm-clear-wrong-words" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700">确认清除</button><button id="cancel-clear-wrong-words" class="px-4 py-2 bg-slate-200 text-slate-700 font-semibold rounded-md hover:bg-slate-300">取消</button></div>`);

            document.getElementById('confirm-clear-wrong-words').onclick = async () => {
                const code = document.getElementById('confirm-code-input').value;
                if (code === '1234') {
                    messageDialog.style.display = 'none';
                    showLoader("正在清除所有记录...");
                    try {
                        const sessionsCollectionPath = `${USER_SESSIONS_COLLECTION_BASE}${userId}/practiceSessions`;
                        const q = query(collection(db, sessionsCollectionPath));
                        const querySnapshot = await getDocs(q);
                        
                        const batch = writeBatch(db);
                        querySnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();

                        await loadPracticeSessionsFromFirestore();
                        showMessage('所有错题记录已清除。');
                        hideInlineWrongWordsSelection();
                        newWordsRadio.checked = true;
                        updatePracticeModeDisplay();
                    } catch (error) {
                        console.error("清除错题记录时出错: ", error);
                        showMessage("清除失败，请检查网络或重试。");
                    } finally {
                        hideLoader();
                    }
                } else {
                    showMessage('确认码不正确，清除操作已取消。');
                }
            };

            document.getElementById('cancel-clear-wrong-words').onclick = () => {
                messageDialog.style.display = 'none';
            };
        });

        // --- Setup Section Logic ---
        wordInput.addEventListener('input', () => {
            if(wordInput.value.trim() !== '') {
                uploadStatus.textContent = '已输入文本，将优先使用文本内容。';
                uploadConfirmButton.disabled = true;
                selectedFile = null;
                fileUpload.value = '';
                newWordsRadio.checked = true;
                updatePracticeModeDisplay();
            } else if (selectedFile) {
                 uploadStatus.textContent = `已选择: ${selectedFile.name}`;
                 uploadConfirmButton.disabled = false;
                 newWordsRadio.checked = true;
                 updatePracticeModeDisplay();
            } else {
                 uploadStatus.textContent = '未选择任何文件';
                 uploadConfirmButton.disabled = true;
            }
            updateStartButtonState();
        });

        selectFileButton.addEventListener('click', () => fileUpload.click());

        fileUpload.addEventListener('change', (event) => {
            selectedFile = event.target.files[0];
            if (!selectedFile) {
                uploadStatus.textContent = '未选择任何文件';
                uploadConfirmButton.disabled = true;
                updateStartButtonState();
                return;
            }
            uploadStatus.textContent = `已选择: ${selectedFile.name}`;
            uploadConfirmButton.disabled = false;
            wordInput.value = '';
            newWordsRadio.checked = true;
            updatePracticeModeDisplay();
            updateStartButtonState();
        });

        uploadConfirmButton.addEventListener('click', async () => {
            if (!selectedFile) return;
            try {
                showLoader('正在处理文件...');
                const base64Data = await fileToBase64(selectedFile);
                const mimeType = selectedFile.type || getMimeType(selectedFile.name);

                showLoader('正在提取文件内容...');
                const extractedText = await extractTextFromFile(base64Data, mimeType);
                
                showLoader('正在解析单词...');
                let parsedWords = parseWordInput(extractedText);
                if (parsedWords.length === 0) throw new Error("文件中未识别到有效单词。");

                showLoader('正在翻译和验证单词...');
                words = await processWordsForQuiz(parsedWords);

                uploadStatus.textContent = `处理完成！共 ${words.length} 个单词。可以开始练习了。`;
                newWordsRadio.checked = true;
                updatePracticeModeDisplay();

            } catch (error) {
                console.error("处理文件失败:", error);
                showMessage(`处理文件失败: ${error.message}`);
                uploadStatus.textContent = '处理失败，请重试。';
                words = [];
            } finally {
                hideLoader();
                updateStartButtonState();
            }
        });

        const getMimeType = (filename) => {
            const extension = filename.split('.').pop().toLowerCase();
            const mimeTypes = {
                'jpg': 'image/jpeg', 'jpeg': 'image/jpeg', 'png': 'image/png', 'gif': 'image/gif', 'heic': 'image/heic',
                'txt': 'text/plain', 'csv': 'text/csv', 'doc': 'application/msword',
                'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'xls': 'application/vnd.ms-excel',
                'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'pdf': 'application/pdf'
            };
            return mimeTypes[extension] || 'application/octet-stream';
        };

        document.querySelectorAll('input[name="practice-mode"]').forEach(radio => {
            radio.addEventListener('change', () => {
                updatePracticeModeDisplay();
            });
        });

        googleTtsCheckbox.addEventListener('change', () => {
            googleTranslateTtsEnabled = googleTtsCheckbox.checked;
        });
        
        startButton.addEventListener('click', async () => {
            unlockAudioContext();
            autoSpeakEnabled = autoSpeakCheckbox.checked;
            
            if (wrongWordsRadio.checked) {
                const selectedSessionIds = Array.from(inlineWrongWordsSessionsList.querySelectorAll('input[type="checkbox"]:checked'))
                                                    .map(checkbox => checkbox.value);
                if (selectedSessionIds.length === 0) {
                    showMessage('请选择至少一个错题练习会话。');
                    return;
                }
                let wordsToPracticeMap = new Map();
                allPracticeSessions.forEach(session => {
                    if (selectedSessionIds.includes(session.id)) {
                        (session.sessionWords || []).forEach(word => {
                            if (!word.wasCorrect) {
                                if (!wordsToPracticeMap.has(word.english)) {
                                     wordsToPracticeMap.set(word.english, { english: word.english, chinese: word.chinese });
                                }
                            }
                        });
                    }
                });
                words = Array.from(wordsToPracticeMap.values());
                startQuiz();
                return;
            } 
            
            else if (wordLibraryRadio.checked) {
                if (words.length === 0) {
                     showMessage('请从单词库中选择至少一个单词。');
                     return;
                }
                startQuiz();
                return;
            }

            if (words.length > 0 && newWordsRadio.checked) { 
                startQuiz();
                return;
            }
            const parsedWords = parseWordInput(wordInput.value);
            if (parsedWords.length === 0) {
                showMessage('请输入单词！'); 
                return;
            }
            try {
                showLoader('正在翻译和验证单词...');
                words = await processWordsForQuiz(parsedWords);
                if (words.length > 0) {
                    startQuiz();
                } else {
                    showMessage('未能成功处理单词，请检查输入或网络。');
                }
            } catch (error) {
                 console.error("处理单词时发生错误:", error);
                 showMessage(`处理单词时发生错误: ${error.message}`);
            } finally {
                hideLoader();
            }
        });

        // --- Word Library Management Logic ---
        const updateSelectedLibraryDisplay = () => {
            if (wordLibraryRadio.checked) {
                if (words.length > 0) {
                    selectedLibraryDisplay.innerHTML = `已选择 <span class="text-indigo-600">${words.length}</span> 个单词`;
                } else {
                    selectedLibraryDisplay.textContent = '未选择单词';
                }
            }
        };

        openManageModalButton.addEventListener('click', () => {
            if (!isAuthReady) {
                showMessage("Firebase 未准备好，无法使用单词库功能。请检查网络。");
                return;
            }
            modalTitle.textContent = '管理单词库';
            manageView.style.display = 'block';
            selectView.style.display = 'none';
            wordLibraryModal.style.display = 'flex';
            loadLibrariesForManageMode();
            subsetManagementSection.style.display = 'none';
            wordsManagementSection.style.display = 'none';
            subsetsList.innerHTML = '<p class="text-center text-slate-500 p-4">请先选择一个单词库。</p>';
            subsetWordsInput.value = '';
        });

        selectLibraryForPracticeButton.addEventListener('click', async () => {
            if (!isAuthReady) {
                showMessage("Firebase 未准备好，无法使用单词库功能。请检查网络。");
                return;
            }
            modalTitle.textContent = '选择单词进行练习';
            manageView.style.display = 'none';
            selectView.style.display = 'block';
            wordLibraryModal.style.display = 'flex';
            await buildPracticeSelectionTree();
        });


        modalCloseButton.addEventListener('click', () => {
            wordLibraryModal.style.display = 'none';
            updateSelectedLibraryDisplay();
            updateStartButtonState();
        });

        createLibraryButton.addEventListener('click', async () => {
            const name = newLibraryNameInput.value.trim();
            if (!name) { showMessage('请输入单词库名称。'); return; }
            if (!userId) { showMessage('用户未认证，无法创建单词库。'); return; }
            showLoader('正在创建单词库...');
            try {
                const librariesRef = collection(db, PUBLIC_LIBRARIES_COLLECTION);
                await addDoc(librariesRef, { name: name, userId: userId });
                newLibraryNameInput.value = '';
                await loadLibrariesForManageMode();
                showMessage(`单词库 "${name}" 创建成功！`);
            } catch (error) {
                console.error("创建单词库失败:", error);
                showMessage("创建单词库失败，请重试。");
            } finally {
                hideLoader();
            }
        });

        const loadLibrariesForManageMode = async () => {
            if (!isAuthReady || !userId) {
                librariesList.innerHTML = '<p class="text-center text-slate-500 p-4">请登录后查看单词库。</p>';
                return;
            }
            showLoader('正在加载单词库...');
            try {
                const librariesRef = collection(db, PUBLIC_LIBRARIES_COLLECTION);
                const querySnapshot = await getDocs(librariesRef);
                allLibraries = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                librariesList.innerHTML = '';
                if (allLibraries.length === 0) {
                    librariesList.innerHTML = '<p class="text-center text-slate-500 p-4">暂无单词库。</p>';
                } else {
                    allLibraries.forEach(library => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-between p-3 hover:bg-slate-100 cursor-pointer border-b border-slate-100 last:border-b-0';
                        div.dataset.id = library.id;
                        div.dataset.name = library.name;
                        
                        const ownerText = library.userId === userId ? ' (我创建的)' : '';
                        div.innerHTML = `<span class="font-medium text-slate-700">${library.name}${ownerText}</span>
                                        <div class="flex gap-2">
                                            <button data-id="${library.id}" data-name="${library.name}" class="rename-library-button px-2 py-1 text-xs font-semibold text-slate-600 bg-slate-200 rounded hover:bg-slate-300">重命名</button>
                                            <button data-id="${library.id}" class="delete-library-button px-2 py-1 text-xs font-semibold text-red-600 bg-red-100 rounded hover:bg-red-200">删除</button>
                                        </div>`;
                        librariesList.appendChild(div);

                        div.addEventListener('click', async (e) => {
                            if (e.target.tagName === 'BUTTON') return;
                            librariesList.querySelectorAll('div').forEach(item => item.classList.remove('bg-indigo-50'));
                            subsetsList.innerHTML = '<p class="text-center text-slate-500 p-4">请先选择一个单词库。</p>';
                            subsetWordsInput.value = '';
                            selectedSubsetId = null;
                            selectedSubsetName = null;
                            wordsManagementSection.style.display = 'none';

                            div.classList.add('bg-indigo-50');
                            selectedLibraryId = library.id;
                            selectedLibraryName = library.name;
                            currentLibraryNameSpan.textContent = selectedLibraryName;
                            subsetManagementSection.style.display = 'block';
                            await loadSubsetsForManageMode(selectedLibraryId);
                        });
                    });
                }
            } catch (error) {
                console.error("加载单词库失败:", error);
                showMessage("加载单词库失败，请检查网络。");
            } finally {
                hideLoader();
            }
        };

        librariesList.addEventListener('click', async (event) => {
            const target = event.target;
            if (target.classList.contains('delete-library-button')) {
                const libraryIdToDelete = target.dataset.id;
                const libraryToDelete = allLibraries.find(lib => lib.id === libraryIdToDelete);

                showMessage(`请输入确认码以删除单词库 "<strong>${libraryToDelete.name}</strong>"。<br>此操作不可撤销！<br><br><input type="text" id="confirm-code-input" class="w-full p-2 border border-slate-300 rounded-md" placeholder="输入确认码"><br><div class="flex gap-2 mt-4 justify-center"><button id="confirm-delete-library" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700">确认删除</button><button id="cancel-delete-library" class="px-4 py-2 bg-slate-200 text-slate-700 font-semibold rounded-md hover:bg-slate-300">取消</button></div>`);

                document.getElementById('confirm-delete-library').onclick = async () => {
                    const code = document.getElementById('confirm-code-input').value;
                    if (code === '1234') {
                        messageDialog.style.display = 'none';
                        showLoader('正在删除单词库...');
                        try {
                            const batch = writeBatch(db);
                            const subsetsToDeleteSnapshot = await getDocs(query(collection(db, PUBLIC_SUBSETS_COLLECTION), where("libraryId", "==", libraryIdToDelete)));
                            for (const subsetDoc of subsetsToDeleteSnapshot.docs) {
                                const wordsSnapshot = await getDocs(query(collection(db, PUBLIC_WORDS_COLLECTION), where("subsetId", "==", subsetDoc.id)));
                                wordsSnapshot.forEach(wordDoc => batch.delete(wordDoc.ref));
                                batch.delete(subsetDoc.ref);
                            }
                            batch.delete(doc(db, PUBLIC_LIBRARIES_COLLECTION, libraryIdToDelete));
                            await batch.commit();

                            if (selectedLibraryId === libraryIdToDelete) {
                                selectedLibraryId = null; selectedLibraryName = null;
                                selectedSubsetId = null; selectedSubsetName = null;
                                subsetManagementSection.style.display = 'none';
                                wordsManagementSection.style.display = 'none';
                            }
                            await loadLibrariesForManageMode();
                            showMessage('单词库已删除。');
                        } catch (error) {
                            console.error("删除单词库失败:", error);
                            showMessage("删除单词库失败，请重试。");
                        } finally {
                            hideLoader();
                        }
                    } else {
                        showMessage('确认码不正确，删除操作已取消。');
                    }
                };
                document.getElementById('cancel-delete-library').onclick = () => {
                    messageDialog.style.display = 'none';
                };
            }
            if (target.classList.contains('rename-library-button')) {
                const libraryId = target.dataset.id;
                const libraryName = target.dataset.name;
                const library = allLibraries.find(lib => lib.id === libraryId);

                const promptHtml = (library.userId === userId) ?
                    `请输入 "${libraryName}" 的新名称：<br><input type="text" id="rename-input" class="w-full p-2 mt-2 border border-slate-300 rounded-md" value="${libraryName}">` :
                    `请输入确认码以重命名单词库 "<strong>${libraryName}</strong>"：<br><input type="text" id="confirm-code-input" class="w-full p-2 mt-2 border border-slate-300 rounded-md" placeholder="输入确认码"><br><input type="text" id="rename-input" class="w-full p-2 mt-2 border border-slate-300 rounded-md" value="${libraryName}" placeholder="新名称">`;

                showMessage(`${promptHtml}<br><br><div class="flex gap-2 mt-2 justify-center"><button id="confirm-rename" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700">确认</button><button id="cancel-rename" class="px-4 py-2 bg-slate-200 text-slate-700 font-semibold rounded-md hover:bg-slate-300">取消</button></div>`);
                
                document.getElementById('confirm-rename').onclick = async () => {
                    const newName = document.getElementById('rename-input').value.trim();
                    const codeInput = document.getElementById('confirm-code-input');
                    if (codeInput && codeInput.value !== '1234') { showMessage('确认码不正确。'); return; }
                    if (!newName) { showMessage('请输入有效的单词库名称。'); return; }
                    
                    showLoader('正在重命名...');
                    try {
                        await setDoc(doc(db, PUBLIC_LIBRARIES_COLLECTION, libraryId), { name: newName }, { merge: true });
                        if (selectedLibraryId === libraryId) { selectedLibraryName = newName; }
                        await loadLibrariesForManageMode();
                        showMessage('单词库名称已更新。');
                    } catch (error) {
                        console.error("重命名失败:", error);
                        showMessage("重命名失败，请重试。");
                    } finally { hideLoader(); }
                };
                document.getElementById('cancel-rename').onclick = () => { messageDialog.style.display = 'none'; };
            } 
        });

        createSubsetButton.addEventListener('click', async () => {
            const name = newSubsetNameInput.value.trim();
            if (!name) { showMessage('请输入子集名称。'); return; }
            if (!selectedLibraryId) { showMessage('请先选择一个单词库。'); return; }
            if (!userId) { showMessage('用户未认证，无法创建子集。'); return; }
            showLoader('正在创建子集...');
            try {
                const subsetsRef = collection(db, PUBLIC_SUBSETS_COLLECTION);
                await addDoc(subsetsRef, { name: name, libraryId: selectedLibraryId, userId: userId });
                newSubsetNameInput.value = '';
                await loadSubsetsForManageMode(selectedLibraryId);
                showMessage(`子集 "${name}" 创建成功！`);
            } catch (error) {
                console.error("创建子集失败:", error);
                showMessage("创建子集失败，请重试。");
            } finally {
                hideLoader();
            }
        });

        const loadSubsetsForManageMode = async (libraryId) => {
            if (!isAuthReady || !userId || !libraryId) {
                subsetsList.innerHTML = '<p class="text-center text-slate-500 p-4">请先选择一个单词库。</p>';
                return;
            }
            showLoader('正在加载子集...');
            try {
                const subsetsRef = collection(db, PUBLIC_SUBSETS_COLLECTION);
                const q = query(subsetsRef, where("libraryId", "==", libraryId));
                const querySnapshot = await getDocs(q);
                const loadedSubsets = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const wordsRef = collection(db, PUBLIC_WORDS_COLLECTION);
                const qWords = query(wordsRef, where("libraryId", "==", libraryId));
                const wordsSnapshot = await getDocs(qWords);
                allWordsInCurrentLibrary = wordsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                subsetsList.innerHTML = '';
                if (loadedSubsets.length === 0) {
                    subsetsList.innerHTML = '<p class="text-center text-slate-500 p-4">暂无子集。</p>';
                } else {
                    loadedSubsets.forEach(subset => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-between p-3 hover:bg-slate-100 border-b border-slate-100 last:border-b-0';
                        if (selectedSubsetId === subset.id) div.classList.add('bg-indigo-50');
                        
                        const wordCount = allWordsInCurrentLibrary.filter(word => word.subsetId === subset.id).length;
                        const ownerText = subset.userId === userId ? ' (我创建的)' : '';
                        
                        div.innerHTML = `<div class="flex-grow cursor-pointer">
                                            <span class="font-medium text-slate-700">${subset.name}</span>
                                            <span class="text-sm text-slate-500 ml-2">${wordCount} 词${ownerText}</span>
                                         </div>
                                        <div class="flex gap-2">
                                            <button data-id="${subset.id}" data-name="${subset.name}" class="rename-subset-button px-2 py-1 text-xs font-semibold text-slate-600 bg-slate-200 rounded hover:bg-slate-300">重命名</button>
                                            <button data-id="${subset.id}" class="delete-subset-button px-2 py-1 text-xs font-semibold text-red-600 bg-red-100 rounded hover:bg-red-200">删除</button>
                                        </div>`;
                        subsetsList.appendChild(div);
                        
                        // Event listener for selecting the subset
                        div.querySelector('.flex-grow').addEventListener('click', async () => {
                            selectedSubsetId = subset.id;
                            selectedSubsetName = subset.name;
                            currentSubsetNameSpan.textContent = selectedSubsetName;
                            
                            wordsManagementSection.style.display = 'block';
                            showLoader('正在加载子集单词...');
                            try {
                                const loadedWords = await loadWordsFromSubset(selectedSubsetId);
                                subsetWordsInput.value = loadedWords.map(w => `${w.english} - ${w.chinese}`).join('\n');
                            } catch (error) {
                                console.error("加载子集单词失败:", error);
                                showMessage("加载子集单词失败。");
                            } finally {
                                hideLoader();
                            }
                            subsetsList.querySelectorAll('div.flex').forEach(item => item.classList.remove('bg-indigo-50'));
                            div.classList.add('bg-indigo-50');
                        });
                    });
                }
            } catch (error) {
                console.error("加载子集失败:", error);
                showMessage("加载子集失败，请检查网络。");
            } finally {
                hideLoader();
            }
        };


        subsetsList.addEventListener('click', async (event) => {
            const target = event.target;
            if (target.classList.contains('delete-subset-button')) {
                const subsetIdToDelete = target.dataset.id;
                const subsetToDelete = allSubsets.find(sub => sub.id === subsetIdToDelete);
                // Simplified check - assuming loadedSubsets is available or re-fetch
                // For now, let's assume if it's visible, it's loaded.
                
                showMessage(`确定要删除子集及其所有单词吗？<br>此操作不可撤销！<br><br><div class="flex gap-2 mt-2 justify-center"><button id="confirm-delete-subset" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700">确认删除</button><button id="cancel-delete-subset" class="px-4 py-2 bg-slate-200 text-slate-700 font-semibold rounded-md hover:bg-slate-300">取消</button></div>`);
                
                document.getElementById('confirm-delete-subset').onclick = async () => {
                    messageDialog.style.display = 'none';
                    showLoader('正在删除子集...');
                    try {
                        const batch = writeBatch(db);
                        const wordsSnapshot = await getDocs(query(collection(db, PUBLIC_WORDS_COLLECTION), where("subsetId", "==", subsetIdToDelete)));
                        wordsSnapshot.forEach(doc => batch.delete(doc.ref));
                        batch.delete(doc(db, PUBLIC_SUBSETS_COLLECTION, subsetIdToDelete));
                        await batch.commit();

                        if (selectedSubsetId === subsetIdToDelete) {
                            selectedSubsetId = null; selectedSubsetName = null;
                            wordsManagementSection.style.display = 'none';
                            subsetWordsInput.value = '';
                        }
                        await loadSubsetsForManageMode(selectedLibraryId);
                        showMessage('子集已删除。');
                    } catch (error) {
                        console.error("删除子集失败:", error);
                        showMessage("删除子集失败，请重试。");
                    } finally {
                        hideLoader();
                    }
                };
                document.getElementById('cancel-delete-subset').onclick = () => { messageDialog.style.display = 'none'; };
            }
            if (target.classList.contains('rename-subset-button')) {
                // Rename logic for subsets can be added here, similar to libraries
            }
        });

        let selectedSubsetFile = null;
        subsetFileUpload.addEventListener('change', (event) => {
            selectedSubsetFile = event.target.files[0];
            if (!selectedSubsetFile) {
                subsetUploadStatus.textContent = '未选择任何文件';
                uploadSubsetConfirmButton.disabled = true;
                return;
            }
            subsetUploadStatus.textContent = `已选择: ${selectedSubsetFile.name}`;
            uploadSubsetConfirmButton.disabled = false;
        });

        selectSubsetFileButton.addEventListener('click', () => {
            subsetFileUpload.click();
        });

        uploadSubsetConfirmButton.addEventListener('click', async () => {
            if (!selectedSubsetId) { showMessage('请先选择一个子集来导入单词。'); return; }
            if (!selectedSubsetFile) { showMessage('请先选择一个文件。'); return; }

            showLoader('正在处理文件...');
            try {
                const base64Data = await fileToBase64(selectedSubsetFile);
                const mimeType = selectedSubsetFile.type || getMimeType(selectedSubsetFile.name);

                const extractedText = await extractTextFromFile(base64Data, mimeType);
                let importedWords = await processWordsForQuiz(parseWordInput(extractedText));

                const existingWords = new Set(subsetWordsInput.value.split('\n').map(line => line.split(/[-=＝－]/)[0].trim().toLowerCase()).filter(Boolean));
                const newWordsToAppend = importedWords.filter(w => !existingWords.has(w.english.toLowerCase()));

                if (newWordsToAppend.length > 0) {
                    const newContentLines = newWordsToAppend.map(w => `${w.english} - ${w.chinese || ''}`);
                    subsetWordsInput.value = subsetWordsInput.value.trim() ? `${subsetWordsInput.value.trim()}\n${newContentLines.join('\n')}` : newContentLines.join('\n');
                    subsetUploadStatus.textContent = `成功导入 ${newWordsToAppend.length} 个新单词。请点击“保存”。`;
                } else {
                    subsetUploadStatus.textContent = `导入完成，没有发现新单词。`;
                }
            } catch (error) {
                console.error("导入文件失败:", error);
                showMessage(`导入文件失败: ${error.message}`);
                subsetUploadStatus.textContent = '导入失败，请重试。';
            } finally {
                hideLoader();
                selectedSubsetFile = null;
                subsetFileUpload.value = '';
                uploadSubsetConfirmButton.disabled = true;
            }
        });


        saveSubsetWordsButton.addEventListener('click', async () => {
            if (!selectedSubsetId) { showMessage('请先选择一个子集。'); return; }
            const rawWordsInput = subsetWordsInput.value.trim();
            saveSubsetWordsButton.disabled = true;
            saveSubsetWordsButton.textContent = '正在保存...';
            
            try {
                const parsedWordsFromInput = parseWordInput(rawWordsInput);
                const processedWordsFromInput = await processWordsForQuiz(parsedWordsFromInput);
                const existingWordsInSubset = await loadWordsFromSubset(selectedSubsetId);

                const existingWordsMap = new Map(existingWordsInSubset.map(w => [w.english.toLowerCase(), w]));
                const inputWordsMap = new Map(processedWordsFromInput.map(w => [w.english.toLowerCase(), w]));

                const batch = writeBatch(db);
                let changesMade = 0;

                for (const [key, inputWord] of inputWordsMap.entries()) {
                    if (existingWordsMap.has(key)) {
                        const existingWord = existingWordsMap.get(key);
                        if (existingWord.chinese !== inputWord.chinese) {
                            batch.update(doc(db, PUBLIC_WORDS_COLLECTION, existingWord.id), { chinese: inputWord.chinese });
                            changesMade++;
                        }
                    } else {
                        batch.set(doc(collection(db, PUBLIC_WORDS_COLLECTION)), {
                            english: inputWord.english, chinese: inputWord.chinese, subsetId: selectedSubsetId,
                            libraryId: selectedLibraryId, userId: userId
                        });
                        changesMade++;
                    }
                }

                for (const [key, existingWord] of existingWordsMap.entries()) {
                    if (!inputWordsMap.has(key)) {
                        batch.delete(doc(db, PUBLIC_WORDS_COLLECTION, existingWord.id));
                        changesMade++;
                    }
                }

                if (changesMade === 0) {
                    showMessage('没有新的或需要更新的单词。');
                } else {
                    await batch.commit();
                    showMessage(`单词已保存！共 ${changesMade} 处变更。`);
                    await loadSubsetsForManageMode(selectedLibraryId);
                }
            } catch (error) {
                console.error("保存单词失败:", error);
                showMessage("保存单词失败，请重试。");
            } finally {
                hideLoader();
                saveSubsetWordsButton.disabled = false;
                saveSubsetWordsButton.textContent = '保存单词到子集';
            }
        });

        const loadWordsFromSubset = async (subsetId) => {
            if (!isAuthReady || !userId || !subsetId) return [];
            try {
                const wordsRef = collection(db, PUBLIC_WORDS_COLLECTION);
                const q = query(wordsRef, where("subsetId", "==", subsetId));
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("从子集加载单词失败:", error);
                showMessage("从子集加载单词失败，请检查网络。");
                return [];
            }
        };
        
        // --- NEW: Word Library Practice Selection Logic ---
        const buildPracticeSelectionTree = async () => {
            librarySelectionTree.innerHTML = '<p class="text-center text-slate-500 p-4">正在加载单词库...</p>';
            if (!isAuthReady) return;

            try {
                const libsSnapshot = await getDocs(query(collection(db, PUBLIC_LIBRARIES_COLLECTION)));
                const allLibs = libsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const subsetsSnapshot = await getDocs(query(collection(db, PUBLIC_SUBSETS_COLLECTION)));
                const allSubsets = subsetsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const wordsSnapshot = await getDocs(query(collection(db, PUBLIC_WORDS_COLLECTION)));
                const allWords = wordsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                librarySelectionTree.innerHTML = '';
                if (allLibs.length === 0) {
                    librarySelectionTree.innerHTML = '<p class="text-center text-slate-500 p-4">没有可用的单词库。</p>';
                    return;
                }

                allLibs.forEach(lib => {
                    const libNode = document.createElement('div');
                    libNode.className = 'library-node';
                    libNode.innerHTML = `<div class="text-lg font-bold text-slate-800 p-2 bg-slate-100 rounded-md">${lib.name}</div>`;
                    
                    const subsetsInLib = allSubsets.filter(s => s.libraryId === lib.id);
                    if (subsetsInLib.length > 0) {
                        const subsetContainer = document.createElement('div');
                        subsetContainer.className = 'pl-4 pt-2 space-y-2';
                        subsetsInLib.forEach(subset => {
                            const subsetNode = document.createElement('div');
                            subsetNode.className = 'subset-node';
                            
                            const wordsInSubset = allWords.filter(w => w.subsetId === subset.id);
                            
                            const subsetHeader = document.createElement('div');
                            subsetHeader.className = 'subset-header flex items-center p-2 rounded-md hover:bg-slate-100 cursor-pointer';
                            subsetHeader.innerHTML = `
                                <span class="subset-toggle text-slate-400 transition-transform mr-2">▶</span>
                                <input type="checkbox" class="subset-checkbox custom-checkbox h-4 w-4 mr-3" data-subset-id="${subset.id}">
                                <label class="font-semibold text-slate-700">${subset.name} (${wordsInSubset.length} 词)</label>
                            `;
                            subsetNode.appendChild(subsetHeader);

                            if (wordsInSubset.length > 0) {
                                const wordsList = document.createElement('ul');
                                wordsList.className = 'words-list-container pl-10 pt-1 space-y-1';
                                wordsList.dataset.subsetId = subset.id;
                                wordsInSubset.forEach(word => {
                                    wordsList.innerHTML += `
                                        <li class="word-item flex items-center">
                                            <input type="checkbox" class="word-checkbox custom-checkbox h-4 w-4 mr-3" data-english="${word.english}" data-chinese="${word.chinese}" data-subset-id="${subset.id}">
                                            <label class="text-slate-600">${word.english} - ${word.chinese}</label>
                                        </li>
                                    `;
                                });
                                subsetNode.appendChild(wordsList);
                            }
                            subsetContainer.appendChild(subsetNode);
                        });
                        libNode.appendChild(subsetContainer);
                    }
                    librarySelectionTree.appendChild(libNode);
                });

            } catch (e) {
                console.error("Error building selection tree:", e);
                librarySelectionTree.innerHTML = '<p class="text-center text-red-500 p-4">加载失败，请重试。</p>';
            }
        };

        librarySelectionTree.addEventListener('click', (e) => {
            const target = e.target;
            // Toggle word list visibility
            if (target.closest('.subset-header')) {
                const header = target.closest('.subset-header');
                const wordList = header.nextElementSibling;
                if (wordList && wordList.classList.contains('words-list-container')) {
                    header.querySelector('.subset-toggle').classList.toggle('expanded');
                    wordList.classList.toggle('show');
                }
            }
        });

        librarySelectionTree.addEventListener('change', (e) => {
            const target = e.target;
            // Subset checkbox changed
            if (target.classList.contains('subset-checkbox')) {
                const subsetId = target.dataset.subsetId;
                const isChecked = target.checked;
                const wordCheckboxes = librarySelectionTree.querySelectorAll(`.word-checkbox[data-subset-id="${subsetId}"]`);
                wordCheckboxes.forEach(cb => cb.checked = isChecked);
            }
            // Word checkbox changed
            if (target.classList.contains('word-checkbox')) {
                const subsetId = target.dataset.subsetId;
                const allWordCheckboxes = librarySelectionTree.querySelectorAll(`.word-checkbox[data-subset-id="${subsetId}"]`);
                const checkedWordCheckboxes = librarySelectionTree.querySelectorAll(`.word-checkbox[data-subset-id="${subsetId}"]:checked`);
                const subsetCheckbox = librarySelectionTree.querySelector(`.subset-checkbox[data-subset-id="${subsetId}"]`);
                
                if (checkedWordCheckboxes.length === allWordCheckboxes.length && allWordCheckboxes.length > 0) {
                    subsetCheckbox.checked = true;
                    subsetCheckbox.indeterminate = false;
                } else if (checkedWordCheckboxes.length > 0) {
                    subsetCheckbox.checked = false;
                    subsetCheckbox.indeterminate = true;
                } else {
                    subsetCheckbox.checked = false;
                    subsetCheckbox.indeterminate = false;
                }
            }
            
            // Update count and button state
            const selectedWords = librarySelectionTree.querySelectorAll('.word-checkbox:checked');
            const count = selectedWords.length;
            selectedWordCountSpan.textContent = count;
            confirmLibrarySelectionButton.disabled = count === 0;
        });

        confirmLibrarySelectionButton.addEventListener('click', () => {
            const selectedWordCheckboxes = librarySelectionTree.querySelectorAll('.word-checkbox:checked');
            words = Array.from(selectedWordCheckboxes).map(cb => ({
                english: cb.dataset.english,
                chinese: cb.dataset.chinese
            }));
            
            wordLibraryModal.style.display = 'none';
            updateSelectedLibraryDisplay();
            updateStartButtonState();
        });

        // Initial update of button states and display
        updatePracticeModeDisplay();
        updateStartButtonState();
    </script>
</body>
</html>
